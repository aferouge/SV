% All possible states for the bridge components
sort
  st_sign    = struct on | off;             %sign status
  st_deck    = struct up | down;            %deck status
  st_barrier = struct lift | lower;         %barrier status
  st_lock    = struct engaged | disengaged; %lock status
  st_bridge  = struct open | close;

act
  sendPre, receivePre, commPre: st_sign;
  rSwitchPre, sSwitchPre, cSwitchPre: st_sign;
  setPreSign: st_sign;

proc
  PreSign(status: st_sign)
    = (status == on) -> rSwitchPre(off) . PreSign(status = off)
    + (status == off) -> rSwitchPre(on) . PreSign(status = on)
    + sendPre(status) . PreSign();

act
  sendStop, receiveStop, commStop: st_sign;
  rSwitchStop, sSwitchStop, cSwitchStop: st_sign;
  setStopSign: st_sign;

proc
  StopSign(status: st_sign)
    = (status == on) -> rSwitchStop(off) . StopSign(status = off)
    + (status == off) -> rSwitchStop(on) . StopSign(status = on)
    + sendStop(status) . StopSign();

act
  sendFrontBarrier, receiveFrontBarrier, commFrontBarrier: st_barrier;
  rFrontBarrier, sFrontBarrier, cFrontBarrier: st_barrier;
  setFrontBarrier: st_barrier;

proc
  FrontBarrier(status: st_barrier)
    = (status == lower) -> rFrontBarrier(lift) . FrontBarrier(status = lift)
    + (status == lift) -> rFrontBarrier(lower) . FrontBarrier(status = lower)
    + sendFrontBarrier(status) . FrontBarrier();

act
  sendBackBarrier, receiveBackBarrier, commBackBarrier: st_barrier;
  rBackBarrier, sBackBarrier, cBackBarrier: st_barrier;
  setBackBarrier: st_barrier;

proc
  BackBarrier(status: st_barrier)
    = (status == lower) -> rBackBarrier(lift) . BackBarrier(status = lift)
    + (status == lift) -> rBackBarrier(lower) . BackBarrier(status = lower)
    + sendBackBarrier(status) . BackBarrier();

act
  sendLock, receiveLock, commLock: st_lock;
  rLock, sLock, cLock: st_lock;
  setLock: st_lock;

proc
  Lock(status: st_lock)
    = (status == engaged) -> rLock(disengaged) . Lock(status = disengaged)
    + (status == disengaged) -> rLock(engaged) . Lock(status = engaged)
    + sendLock(status) . Lock();

act
  sendDeck, receiveDeck, commDeck: st_deck;
  sDeck, rDeck, cDeck: st_deck;
  setDeck: st_deck;

proc
  Deck(status: st_deck)
    = (status == up) -> rDeck(down) . Deck(status = down)
    + (status == down) -> rDeck(up) . Deck(status = up)
    + sendDeck(status) . Deck();

proc
  SafetyLayer
    = setPreSign(on) . (receivePre(on) + receivePre(off) . sSwitchPre(on)) . SafetyLayer()
    + setPreSign(off) . (receivePre(off) + receivePre(on) . (receiveStop(off) . sSwitchPre(off) + receiveStop(on))) . SafetyLayer()

    + setStopSign(on) . (receiveStop(on) + receiveStop(off) . (receivePre(on) . sSwitchStop(on) + receivePre(off))) . SafetyLayer()
    + setStopSign(off) . (receiveStop(off) + receiveStop(on) . (receiveFrontBarrier(lift) . sSwitchStop(off) + receiveFrontBarrier(lower))) . SafetyLayer()

    + setFrontBarrier(lower) . (receiveFrontBarrier(lower) + receiveFrontBarrier(lift) . (receiveStop(on) . sFrontBarrier(lower) + receiveStop(off))) . SafetyLayer()
    + setFrontBarrier(lift) . (receiveFrontBarrier(lift) + receiveFrontBarrier(lower) . (receiveBackBarrier(lift) . sFrontBarrier(lift) + receiveBackBarrier(lower))) . SafetyLayer()

    + setBackBarrier(lower) . (receiveBackBarrier(lower) + receiveBackBarrier(lift) . (receiveFrontBarrier(lower) . sBackBarrier(lower) + receiveFrontBarrier(lift))) . SafetyLayer()
    + setBackBarrier(lift) . (receiveBackBarrier(lift) + receiveBackBarrier(lower) . (receiveLock(engaged) . sBackBarrier(lift) + receiveLock(disengaged))) . SafetyLayer()

    + setLock(engaged) . (receiveLock(engaged) + receiveLock(disengaged) . (receiveDeck(down) . sLock(engaged) + receiveDeck(up))) . SafetyLayer()
    + setLock(disengaged) . (receiveLock(disengaged) + receiveLock(engaged) . (receiveBackBarrier(lower) . sLock(disengaged) + receiveBackBarrier(lift))) . SafetyLayer()

    + setDeck(up) . (receiveDeck(up) + receiveDeck(down) . (receiveLock(disengaged) . sDeck(up) + receiveLock(engaged))) . SafetyLayer()
    + setDeck(down) . (receiveDeck(down) + receiveDeck(up) . (receiveLock(disengaged) . sDeck(down) + receiveLock(engaged))) . SafetyLayer();

init
  allow({
    setPreSign,
    commPre,
    cSwitchPre,

    setStopSign,
    commStop,
    cSwitchStop,

    setFrontBarrier,
    commFrontBarrier,
    cFrontBarrier,

    setBackBarrier,
    commBackBarrier,
    cBackBarrier,

    setLock,
    commLock,
    cLock,

    setDeck,
    commDeck,
    cDeck
  },
  comm({
    receivePre|sendPre -> commPre,
    rSwitchPre|sSwitchPre -> cSwitchPre,

    receiveStop|sendStop -> commStop,
    rSwitchStop|sSwitchStop -> cSwitchStop,

    receiveFrontBarrier|sendFrontBarrier -> commFrontBarrier,
    rFrontBarrier|sFrontBarrier -> cFrontBarrier,

    receiveBackBarrier|sendBackBarrier -> commBackBarrier,
    rBackBarrier|sBackBarrier -> cBackBarrier,

    receiveLock|sendLock -> commLock,
    rLock|sLock -> cLock,

    receiveDeck|sendDeck -> commDeck,
    rDeck|sDeck -> cDeck
  },
       PreSign(off)
    || StopSign(off)
    || FrontBarrier(lift)
    || BackBarrier(lift)
    || Lock(engaged)
    || Deck(down)
    || SafetyLayer
  ));
